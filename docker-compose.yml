version: '3.8'

services:
  # ===== RAG SYSTEM =====
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx1g  # Laptop-friendly memory settings
      - DISABLE_SECURITY_PLUGIN=true  # For local development only
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"  # REST API
      - "9600:9600"  # Performance Analyzer
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.11.0
    container_name: opensearch-dashboards
    depends_on:
      - opensearch
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "5601:5601"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  rag-api:
    build:
      context: ./rag-system
      dockerfile: Dockerfile
    container_name: rag-api
    depends_on:
      opensearch:
        condition: service_healthy
    environment:
      - OPENSEARCH_HOST=${OPENSEARCH_HOST:-http://opensearch}
      - OPENSEARCH_PORT=${OPENSEARCH_PORT:-9200}
      - OPENSEARCH_INDEX=${OPENSEARCH_INDEX:-raglab-docs}
      - OPENSEARCH_USE_SSL=${OPENSEARCH_USE_SSL:-false}
      - OPENSEARCH_VERIFY_CERTS=${OPENSEARCH_VERIFY_CERTS:-false}
      - STORAGE_BACKEND=local
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8001:8000"
    volumes:
      # Shared data directories (read-only for raw data)
      - ./data/raw:/app/data/raw:ro
      - ./data/processed:/app/data/processed:ro
      - ./data/indexed:/app/data/indexed
      - ./data/quarantine/rag-failed:/app/quarantine
      - ./output/rag:/app/output
      - ./.state/rag:/app/.state
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===== ETL FRAMEWORK =====
  etl-api:
    build:
      context: ./ai-etl-framework
      dockerfile: Dockerfile
    container_name: etl-api
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://etl_user:${POSTGRES_PASSWORD:-etl_pass}@postgres:5432/etl
      - STORAGE_BACKEND=local
    ports:
      - "8002:8000"
    volumes:
      # Shared data directories
      - ./data/raw:/app/data/raw:ro
      - ./data/processed:/app/data/processed
      - ./data/quarantine/etl-failed:/app/quarantine
      - ./output/etl:/app/output
      - ./.state/etl:/app/.state
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=etl
      - POSTGRES_USER=etl_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-etl_pass}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U etl_user -d etl"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  opensearch-data:
    driver: local
  postgres-data:
    driver: local

networks:
  default:
    name: ai-platform
    driver: bridge
